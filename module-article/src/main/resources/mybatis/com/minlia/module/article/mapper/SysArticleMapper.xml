<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.minlia.module.article.mapper.SysArticleMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.minlia.module.article.entity.SysArticleEntity">
        <result column="id" property="id"/>
        <result column="create_by" property="createBy"/>
        <result column="create_date" property="createDate"/>
        <result column="last_modified_by" property="lastModifiedBy"/>
        <result column="last_modified_date" property="lastModifiedDate"/>
        <result column="category_id" property="categoryId"/>
        <result column="code" property="code"/>
        <result column="title" property="title"/>
        <result column="content" property="content"/>
        <result column="description" property="description"/>
        <result column="locale" property="locale"/>
        <result column="draft_flag" property="draftFlag"/>
        <result column="dis_flag" property="disFlag"/>
        <result column="del_flag" property="delFlag"/>
        <result column="read_count" property="readCount"/>
        <result column="cover" property="cover"/>
        <result column="keywords" property="keywords"/>
        <result column="remark" property="remark"/>
        <result column="attribute1" property="attribute1"/>
        <result column="attribute2" property="attribute2"/>
        <result column="attribute3" property="attribute3"/>
        <result column="attribute4" property="attribute4"/>
        <result column="attribute5" property="attribute5"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id,
        create_by,
        create_date,
        last_modified_by,
        last_modified_date,
        category_id, `code`, title, content, description, locale, draft_flag, dis_flag, del_flag, read_count, cover, keywords, remark, attribute1, attribute2, attribute3, attribute4, attribute5
    </sql>

    <update id="plusReadCount">
        UPDATE sys_article SET read_count = read_count + #{increment} WHERE id = #{id};
    </update>

    <resultMap id="details_map" type="com.minlia.module.article.bean.vo.ArticleVo">
        <id column="id" property="id"/>
        <collection property="labelIds" ofType="java.lang.Long" column="id" select="selectLabelIds"/>
    </resultMap>

    <select id="selectLabelIds" resultType="java.lang.Long">
        SELECT label_id FROM sys_article_label_relation WHERE article_id = #{id};
    </select>

    <select id="selectDetailsById" resultMap="details_map">
        SELECT
            id,
            create_by,
            create_date,
            last_modified_by,
            last_modified_date,
            category_id,
            `code`,
            title,
            content,
            description,
            locale,
            draft_flag,
            dis_flag,
            del_flag,
            read_count,
            cover,
            keywords,
            remark,
            attribute1,
            attribute2,
            attribute3,
            attribute4,
            attribute5,
            (SELECT `name` FROM sys_article_category WHERE id =  sys_article.category_id) AS categoryName,
            (SELECT COUNT(1) FROM sys_article_comment WHERE article_id = sys_article.id) AS commentCount,
            (SELECT COUNT(1) FROM sys_article_praise WHERE article_id = sys_article.id) AS praiseCount,
            (SELECT COUNT(1) FROM sys_article_collection WHERE article_id = sys_article.id) AS collectionCount
        FROM
            sys_article
        where id = #{id}
    </select>

    <select id="selectDetailsByCode" resultMap="details_map">
        SELECT
            id,
            create_by,
            create_date,
            last_modified_by,
            last_modified_date,
            category_id,
            `code`,
            title,
            content,
            description,
            locale,
            draft_flag,
            dis_flag,
            del_flag,
            read_count,
            cover,
            keywords,
            remark,
            attribute1,
            attribute2,
            attribute3,
            attribute4,
            attribute5,
            (SELECT `name` FROM sys_article_category WHERE id =  sys_article.category_id) AS categoryName,
            (SELECT COUNT(1) FROM sys_article_comment WHERE article_id = sys_article.id) AS commentCount,
            (SELECT COUNT(1) FROM sys_article_praise WHERE article_id = sys_article.id) AS praiseCount,
            (SELECT COUNT(1) FROM sys_article_collection WHERE article_id = sys_article.id) AS collectionCount
        FROM
            sys_article
        where `code` = #{code} and locale = #{locale}
    </select>

    <select id="pageVo" resultType="com.minlia.module.article.bean.vo.ArticleVo">
        SELECT
            id,
            create_by,
            create_date,
            last_modified_by,
            last_modified_date,
            category_id,
            `code`
            title,
            content,
            description,
            locale,
            draft_flag,
            dis_flag,
            del_flag,
            read_count,
            cover,
            keywords,
            remark,
            attribute1,
            attribute2,
            attribute3,
            attribute4,
            attribute5,
            (SELECT `name` FROM sys_article_category WHERE id =  sys_article.category_id) AS categoryName,
            (SELECT COUNT(1) FROM sys_article_comment WHERE article_id = sys_article.id) AS commentCount,
            (SELECT COUNT(1) FROM sys_article_praise WHERE article_id = sys_article.id) AS praiseCount,
            (SELECT COUNT(1) FROM sys_article_collection WHERE article_id = sys_article.id) AS collectionCount
        FROM
            sys_article
        ${ew.sqlSegment}
    </select>

</mapper>